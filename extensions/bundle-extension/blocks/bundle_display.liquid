{% comment %}
  bundle_display.liquid
  - Render bundle on product page
  - Add bundle items to cart
  - Discount is applied by Shopify Function
{% endcomment %}

{% assign bundle_data = product.metafields.custom.bundle_data.value %}

{% if bundle_data != blank %}
  <style>
    .bundle-container {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      background-color: #fff;
    }
    .bundle-header {
      margin-bottom: 16px;
      border-bottom: 1px solid #f3f4f6;
      padding-bottom: 12px;
    }
    .bundle-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin: 0 0 8px 0;
      color: #111827;
    }
    .bundle-badge {
      display: inline-block;
      padding: 4px 8px;
      background-color: #d1fae5;
      color: #065f46;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .bundle-items {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }
    .bundle-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f3f4f6;
    }
    .bundle-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    .bundle-item-image {
      width: 60px;
      height: 60px;
      border-radius: 6px;
      object-fit: cover;
      background-color: #f9fafb;
    }
    .bundle-item-info {
      flex: 1;
    }
    .bundle-item-title {
      font-weight: 500;
      color: #374151;
      margin: 0;
    }
    .bundle-item-price {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 0.875rem;
    }
    .price-old {
      text-decoration: line-through;
      color: #9ca3af;
    }
    .price-new {
      font-weight: 600;
      color: #059669;
    }
    .bundle-footer {
      background-color: #f9fafb;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
    }
    .bundle-summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    .bundle-total-row {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
      font-weight: 700;
      font-size: 1.1rem;
    }
    .btn-add-bundle {
      width: 100%;
      background-color: #000;
      color: #fff;
      padding: 12px;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      transition: background-color 0.2s;
    }
    .btn-add-bundle:hover {
      background-color: #333;
    }
  </style>

  <div
    id="bundle-app"
    class="bundle-container"
    data-bundle-id="{{ bundle_data.bundleId }}"
    data-bundle-name="{{ bundle_data.name }}"
  >
    <div class="bundle-header">
      <h3 class="bundle-title">{{ bundle_data.name }}</h3>
      {% if bundle_data.discountValue > 0 %}
        <span class="bundle-badge">
          Discount:
          {% if bundle_data.discountType == 'percentage' %}
            {{ bundle_data.discountValue }}% Off
          {% else %}
            Save {{ bundle_data.discountValue | money }}
          {% endif %}
          (Per Item)
        </span>
      {% endif %}
    </div>

    <div class="bundle-items">
      {% assign total_original = 0 %}
      {% assign total_new = 0 %}
      {% assign discount_val = bundle_data.discountValue | plus: 0 %}

      {% for item in bundle_data.items %}
        {% assign item_price = item.price %}
        {% assign item_qty = item.quantity | default: 1 %}
        
        {% comment %} Calculate Item Discount {% endcomment %}
        {% assign item_discount_amount = 0 %}
        
        {% if bundle_data.discountType == 'percentage' %}
          {% assign discount_factor = discount_val | divided_by: 100.0 %}
          {% assign item_discount_amount = item_price | times: discount_factor %}
        {% else %}
          {% assign item_discount_amount = discount_val %}
        {% endif %}

        {% assign item_new_price = item_price | minus: item_discount_amount %}
        {% if item_new_price < 0 %}{% assign item_new_price = 0 %}{% endif %}

        {% comment %} Accumulate Totals {% endcomment %}
        {% assign line_original = item_price | times: item_qty %}
        {% assign line_new = item_new_price | times: item_qty %}
        
        {% assign total_original = total_original | plus: line_original %}
        {% assign total_new = total_new | plus: line_new %}

        {% comment %} Convert to cents for money filter {% endcomment %}
        {% assign price_old_cents = item.price | times: 100 %}
        {% assign price_new_cents = item_new_price | times: 100 %}

        <div class="bundle-item">
          {% if item.image %}
            <img src="{{ item.image }}" alt="{{ item.title }}" class="bundle-item-image">
          {% else %}
             {% assign fallback_image = blank %}
             {% if item.handle %}
                {% assign prod_ref = all_products[item.handle] %}
                {% if prod_ref.featured_image %}
                  {% assign fallback_image = prod_ref.featured_image %}
                {% endif %}
             {% endif %}
             
             {% if fallback_image %}
               <img src="{{ fallback_image | img_url: '120x120', crop: 'center' }}" alt="{{ item.title }}" class="bundle-item-image">
             {% else %}
                <div class="bundle-item-image" style="display:flex;align-items:center;justify-content:center;color:#ccc;">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                </div>
             {% endif %}
          {% endif %}
          
          <div class="bundle-item-info">
            <p class="bundle-item-title">{{ item.title }}</p>
            {% if item.variantTitle and item.variantTitle != 'Default Title' %}
              <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #6b7280;">{{ item.variantTitle }}</p>
            {% endif %}
            <div class="bundle-item-price">
              <span class="price-old">{{ price_old_cents | money }}</span>
              <span class="price-new">{{ price_new_cents | money }}</span>
              {% if item_qty > 1 %}
                <span style="color:#666;font-size:0.8em;">x{{ item_qty }}</span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="bundle-footer">
      {% assign total_original_cents = total_original | times: 100 %}
      {% assign total_new_cents = total_new | times: 100 %}
      
      <div class="bundle-summary-row">
        <span>Total Value:</span>
        <span style="text-decoration: line-through;">{{ total_original_cents | money }}</span>
      </div>
      <div class="bundle-total-row">
        <span>Bundle Price:</span>
        <span style="color: #059669;">{{ total_new_cents | money }}</span>
      </div>
      
      <button id="add-bundle-to-cart" class="btn-add-bundle" type="button">
        Add Bundle to Cart - {{ total_new_cents | money }}
      </button>
    </div>
  </div>

  <script>
    (function () {
      const root = document.getElementById("bundle-app");
      if (!root) return;

      const bundleId = root.dataset.bundleId;
      const bundleName = root.dataset.bundleName;

      // Note: We use the items exactly as they are in the metafield
      const bundleItems = {{ bundle_data.items | json }};

      document
        .getElementById("add-bundle-to-cart")
        .addEventListener("click", async function () {
          const btn = this;
          const originalText = btn.innerText;
          btn.innerText = "Adding...";
          btn.disabled = true;

          const items = bundleItems.map(item => {
            return {
              id: item.variantId.split("/").pop(), // Extract ID from GID
              quantity: item.quantity || 1,
              properties: {
                _is_bundle: "true",
                _bundle_id: bundleId,
                _bundle_name: bundleName,
                
                // Pass attributes to cart for the Function to read
                _bundle_discount_value: {{ bundle_data.discountValue | json }},
                _bundle_discount_type: {{ bundle_data.discountType | json }}
              }
            };
          });

          try {
            const res = await fetch("/cart/add.js", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ items })
            });

            if (!res.ok) throw new Error("Add bundle failed");

            // Redirect to cart or open drawer
            window.location.href = "/cart";
          } catch (err) {
            console.error(err);
            alert("Failed to add bundle to cart");
            btn.innerText = originalText;
            btn.disabled = false;
          }
        });
    })();
  </script>
{% endif %}

{% schema %}
{
  "name": "Bundle display",
  "target": "section",
  "settings": []
}
{% endschema %}