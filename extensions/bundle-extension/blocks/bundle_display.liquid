{% assign related_bundles = product.metafields.custom.related_bundles.value %}

{% if related_bundles != blank %}
  <style>
    .dhd-bundle-section { margin: 30px 0; border: 2px solid #3b82f6; border-radius: 12px; overflow: hidden; background-color: #f8faff; text-align: left; }
    .dhd-bundle-header { background-color: #3b82f6; color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
    .dhd-bundle-header h3 { margin: 0 !important; font-size: 1.1rem !important; color: white !important; font-weight: 700 !important; }
    .dhd-discount-badge { background-color: #fcd34d; color: #92400e; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: 800; }
    .dhd-bundle-content { padding: 20px; }
    .dhd-bundle-item { display: flex; align-items: center; gap: 15px; padding: 10px 0; border-bottom: 1px solid #e5eaf5; }
    .dhd-bundle-item:last-child { border-bottom: none; }
    .dhd-bundle-item-link { text-decoration: none !important; color: inherit !important; display: flex; align-items: center; gap: 15px; flex: 1; }
    .dhd-bundle-item-link:hover .dhd-bundle-item-title { color: #2563eb !important; text-decoration: underline !important; }
    .dhd-bundle-item-img { width: 60px !important; height: 60px !important; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
    .dhd-bundle-item-title { font-size: 0.95rem !important; font-weight: 600 !important; color: #111; margin: 0; }
    .dhd-item-prices { display: flex; gap: 8px; align-items: center; margin-top: 4px; }
    .dhd-item-old-price { font-size: 0.85rem !important; color: #94a3b8 !important; text-decoration: line-through !important; }
    .dhd-item-new-price { font-size: 0.9rem !important; font-weight: 700 !important; color: #059669 !important; }
    .dhd-bundle-footer { margin-top: 20px; padding-top: 15px; border-top: 2px dashed #cbd5e1; }
    .dhd-total-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .dhd-total-old { text-decoration: line-through; color: #94a3b8; }
    .dhd-total-new { font-size: 1.4rem; font-weight: 800; color: #059669; }
    .dhd-add-bundle-btn { width: 100%; background-color: #2563eb !important; color: white !important; padding: 14px !important; border: none !important; border-radius: 8px !important; font-weight: 700 !important; cursor: pointer !important; }
    .dhd-add-bundle-btn:hover { background-color: #1d4ed8 !important; }
  </style>

  {% for bundle in related_bundles %}
    {% if bundle.active == true or bundle.active == "true" %}
      <div class="dhd-bundle-section">
        <div class="dhd-bundle-header">
          <h3>{{ bundle.bundleName }}</h3>
          {% if bundle.discountValue > 0 %}
            <div class="dhd-discount-badge">
              {% if bundle.discountType == "percentage" %}SAVE {{ bundle.discountValue }}%{% else %}SAVE {{ bundle.discountValue | times: 100 | money }} OFF{% endif %}
            </div>
          {% endif %}
        </div>
        <div class="dhd-bundle-content">
          {% for item in bundle.items %}
            <div class="dhd-bundle-item">
              <a href="/products/{{ item.handle }}" class="dhd-bundle-item-link">
                <img src="{{ item.image | default: 'https://cdn.shopify.com/s/images/admin/no-image-60x60.gif' }}" class="dhd-bundle-item-img" alt="{{ item.title }}">
                <div class="dhd-bundle-item-info">
                  <p class="dhd-bundle-item-title">{{ item.title }}</p>
                  <div class="dhd-item-prices">
                    {% if bundle.discountValue > 0 %}
                      <span class="dhd-item-old-price">{{ item.price | times: 100 | money }}</span>
                      {% assign discounted_price = item.price %}{% if bundle.discountType == "percentage" %}{% assign factor = 100 | minus: bundle.discountValue | divided_by: 100.0 %}{% assign discounted_price = item.price | times: factor %}{% else %}{% assign discounted_price = item.price | minus: bundle.discountValue %}{% endif %}
                      <span class="dhd-item-new-price">{{ discounted_price | times: 100 | money }}</span>
                    {% else %}<span class="dhd-item-new-price">{{ item.price | times: 100 | money }}</span>{% endif %}
                  </div>
                </div>
              </a>
            </div>
          {% endfor %}
          <div class="dhd-bundle-footer">
            <div class="dhd-total-row"><span>Original Total:</span><span class="dhd-total-old">{{ bundle.originalPrice | times: 100 | money }}</span></div>
            <div class="dhd-total-row"><span>Bundle Price:</span><span class="dhd-total-new">{{ bundle.bundlePrice | times: 100 | money }}</span></div>
            <button type="button" class="dhd-add-bundle-btn" onclick='addBundleItemsToCart(event, {{ bundle | json | escape }})'>Add Bundle to Cart</button>
          </div>
        </div>
      </div>
    {% endif %}
  {% endfor %}

  <script>
    async function addBundleItemsToCart(event, bundleStr) {
        event.preventDefault();
        const btn = event.currentTarget;
        let bundle = typeof bundleStr === 'string' ? JSON.parse(bundleStr) : bundleStr;
        const originalText = btn.innerText;
        btn.innerText = "Adding...";
        btn.disabled = true;

        const items = bundle.items.map(item => ({
            id: item.variantId.split("/").pop(),
            quantity: 1,
            properties: { "Bundle": bundle.bundleName, "_is_bundle": "true", "_bundle_id": bundle.bundleId }
        }));

        try {
            const response = await fetch("/cart/add.js", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ items })
            });
            if (response.ok) { window.location.href = "/cart"; } 
            else { throw new Error("Failed to add bundle"); }
        } catch (error) {
            alert(error.message);
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
  </script>
{% endif %}

{% schema %}
{
  "name": "Bundle Display (PDP)",
  "target": "section",
  "settings": []
}
{% endschema %}
